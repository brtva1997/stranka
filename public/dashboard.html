<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Splátkový kalendář</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="card card-wide">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Splátkový kalendář</h2>
      <button id="logout" style="background:#555;">Odhlásit se</button>
    </div>

    <div class="summary">
      Celkem k úhradě: <strong>£ 4 000</strong> |
      Zbývá splatit: <strong id="remain">–</strong>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th><th>Datum</th><th>Částka (£)</th><th>Typ</th><th>Stav</th><th>Akce</th>
        </tr>
      </thead>
      <tbody id="tbl"></tbody>
    </table>
  </div>

<script>
let ROLE = 'user';

(async function init() {
  // Info o uživateli
  const uRes = await fetch('/api/user');
  if (!uRes.ok) return location.href = '/index.html';
  const user = await uRes.json();
  ROLE = user.role;

  // Souhrn
  await updateSummary();

  // Platby
  const data = await fetch('/api/payments').then(r=>r.json());
  const tbody = document.getElementById('tbl');

  data.forEach(p => {
    const tr = document.createElement('tr');
    tr.dataset.id = p.id;

    const typeLabel = p.type === 'nájem' ? '<small class="text-info">nájem</small>' : '';

    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.date}</td>
      <td>${ROLE==='admin'
          ? `<input type="number" value="${p.amount}" style="width:80px;border-radius:6px;">`
          : p.amount}</td>
      <td>${typeLabel}</td>
      <td class="form-check">${ROLE==='admin'
          ? `<input type="checkbox" ${p.status==='zaplaceno'?'checked':''}>`
          : (p.status==='zaplaceno'?'✔':'✘')}</td>
      <td>${ROLE==='admin'
          ? '<button class="save" style="padding:.3rem .8rem;">Uložit</button>'
          : ''}</td>`;
    tbody.appendChild(tr);
  });
})();

document.getElementById('tbl').addEventListener('click', async e => {
  if (!e.target.classList.contains('save')) return;
  const tr = e.target.closest('tr');
  const id = Number(tr.dataset.id);
  const amount = tr.querySelector('input[type="number"]').value;
  const paid = tr.querySelector('input[type="checkbox"]').checked ? 'zaplaceno' : 'nezaplaceno';

  const r = await fetch('/api/payment-update', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, amount, status: paid })
  });
  if (r.ok) {
    e.target.textContent = '✓';
    await updateSummary();
  } else alert('Uložení selhalo');
});

async function updateSummary() {
  const s = await fetch('/api/summary').then(r=>r.json());
  document.getElementById('remain').textContent =
    `£ ${s.remaining.toLocaleString('en-GB')}`;
}

// Logout
document.getElementById('logout').onclick =
  () => fetch('/logout',{method:'POST'}).then(()=>location.href='/index.html');
</script>
</body>
</html>
