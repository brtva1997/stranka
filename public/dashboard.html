<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Splátkový kalendář</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="dark">
  <div class="container">
    <h2>Splátkový kalendář</h2>
    <p id="userInfo"></p>
    <p>Celkově splaceno: <strong id="paidTotal">0</strong> GBP</p>
    <table id="paymentsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Datum</th>
          <th>Částka</th>
          <th>Popis</th>
          <th>Započítat</th>
          <th>Zaplaceno</th>
          <th>Akce</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <br />
    <a href="/logout">Odhlásit se</a>
  </div>

  <script>
    async function loadPayments() {
      const res = await fetch('/api/payments');
      const data = await res.json();
      const tbody = document.querySelector('#paymentsTable tbody');
      const totalEl = document.getElementById('paidTotal');
      const userInfo = document.getElementById('userInfo');

      userInfo.textContent = `Přihlášen jako: ${data.user.username} (${data.user.role})`;
      totalEl.textContent = data.paidTotal;

      data.payments.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.week}</td>
          <td>${p.amount}</td>
          <td>${p.label || ''}</td>
          <td>${p.includeInTotal ? '✅' : '❌'}</td>
          <td>${p.paid ? '✅' : '❌'}</td>
          <td>${data.user.role === 'admin' ? `
            <input type="checkbox" data-id="${p.id}" ${p.paid ? 'checked' : ''}>
          ` : ''}</td>
        `;
        tbody.appendChild(tr);
      });

      // Přidání posluchačů pro admina
      if (data.user.role === 'admin') {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', async () => {
            const id = Number(cb.getAttribute('data-id'));
            const paid = cb.checked;
            await fetch('/api/update-payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, paid })
            });
            loadPayments(); // Obnov data
          });
        });
      }
    }

    loadPayments();
  </script>
</body>
</html>
